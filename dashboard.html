<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Analytics â€” Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    .table-card { opacity:1!important;transform:none!important;animation:none!important;overflow:visible!important; }
    .t-scroll { overflow-x:auto!important;overflow-y:auto!important;max-height:600px!important;height:auto!important; }
    #tBody tr { opacity:1!important;transform:none!important;animation:none!important;visibility:visible!important; }
    #tBody td { opacity:1!important;visibility:visible!important; }
    .table-card { border-radius:18px;outline:1.5px solid var(--border);border:none!important; }
    .t-scroll th,.t-scroll td { white-space:nowrap;padding:9px 12px!important;font-size:.76rem; }
    .t-scroll th:nth-child(1),.t-scroll td:nth-child(1){min-width:140px;}
    .t-scroll th:nth-child(2),.t-scroll td:nth-child(2){min-width:148px;}
    .t-scroll th:nth-child(3),.t-scroll td:nth-child(3){min-width:68px;}
    .t-scroll th:nth-child(4),.t-scroll td:nth-child(4){min-width:60px;}
    .t-scroll th:nth-child(5),.t-scroll td:nth-child(5){min-width:115px;}
    .t-scroll th:nth-child(6),.t-scroll td:nth-child(6){min-width:85px;}
    .t-scroll th:nth-child(7),.t-scroll td:nth-child(7){min-width:78px;}
    .tok-cell{font-size:.76rem;font-weight:700;color:var(--ink2);cursor:default;}
    .tok-sep{color:var(--ink4);margin:0 3px;font-weight:400;}
    #sv3sub{font-size:.66rem;line-height:1.5;}
    #sv5sub{font-size:.66rem;line-height:1.5;}
    .sp-cost{background:#fff7ed;color:#c2540a;border:1.5px solid #fed7aa;}
    .sp-tokens{background:#f0fdf4;color:#166534;border:1.5px solid #bbf7d0;}

    .sync-btn{
      display:flex;align-items:center;gap:6px;padding:7px 16px;
      background:var(--mint-l);border:1.5px solid var(--mint-m);
      border-radius:50px;font-family:'Nunito',sans-serif;
      font-size:.78rem;font-weight:700;color:var(--mint);cursor:pointer;transition:all .15s;
    }
    .sync-btn:hover{background:var(--mint);color:#fff;}
    .sync-btn:disabled{opacity:.5;cursor:not-allowed;}
    .sync-btn.syncing{animation:syncPulse 1s ease-in-out infinite;}
    @keyframes syncPulse{0%,100%{opacity:1}50%{opacity:.5}}

    .resync-btn{
      display:flex;align-items:center;gap:6px;padding:7px 16px;
      background:var(--amber-l);border:1.5px solid var(--amber-m);
      border-radius:50px;font-family:'Nunito',sans-serif;
      font-size:.78rem;font-weight:700;color:#92400e;cursor:pointer;transition:all .15s;
    }
    .resync-btn:hover{background:var(--amber);color:#fff;}
    .resync-btn:disabled{opacity:.5;cursor:not-allowed;}

    .sync-status{
      font-size:.65rem;font-weight:700;color:var(--ink3);
      display:flex;align-items:center;gap:5px;
    }
    .sync-dot{width:6px;height:6px;border-radius:50%;background:var(--mint);}
    .sync-dot.stale{background:var(--amber);}
    .sync-dot.never{background:var(--rose);}
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <a class="back-btn" href="index.html">â†</a>
  <div class="agent-av" id="agentAv" data-color="lav">ğŸ¤–</div>
  <div class="agent-info">
    <div class="agent-name" id="agentName">Loadingâ€¦</div>
    <div class="agent-id"   id="agentIdEl">â€”</div>
  </div>
  <div style="flex:1"></div>
  <div id="syncWrap" style="display:none;align-items:center;gap:10px;">
    <div class="sync-status" id="syncStatus">
      <div class="sync-dot never" id="syncDot"></div>
      <span id="syncLabel">Never synced</span>
    </div>
    <!-- Full re-sync: wipes DB cache and re-fetches everything fresh -->
    <button class="resync-btn" id="resyncBtn" onclick="triggerFullResync()" title="Wipe cache and re-fetch all conversations (fixes missing cost/token data)">â™»ï¸ Re-sync All</button>
    <!-- Delta sync: only fetches new conversations since last sync -->
    <button class="sync-btn" id="syncBtn" onclick="triggerSync()">ğŸ”„ Sync Now</button>
  </div>
  <div class="tab-bar" style="margin-left:12px;">
    <button class="tab-btn active" id="tabOv" onclick="switchTab('ov')">ğŸ“Š Overview</button>
    <button class="tab-btn"        id="tabCh" onclick="switchTab('ch')">ğŸ’¬ Chat History</button>
  </div>
</div>
<div class="loading-bar" id="loadBar"></div>

<!-- â•â• OVERVIEW â•â• -->
<div id="overviewScreen" class="screen active">
  <div class="stats-row" id="statsRow">
    <div class="stat-card" style="animation-delay:0ms">
      <div class="sc-label">Number of Calls</div>
      <div class="sc-val" id="sv1">â€”</div>
      <div class="sc-sub">total sessions</div>
    </div>
    <div class="stat-card" style="animation-delay:50ms">
      <div class="sc-label">Average Duration</div>
      <div class="sc-val" id="sv2">â€”</div>
      <div class="sc-sub">per session</div>
    </div>
    <div class="stat-card" style="animation-delay:100ms">
      <div class="sc-label">Total Tokens Used</div>
      <div class="sc-val" id="sv3">â€”</div>
      <div class="sc-sub" id="sv3sub">input + output</div>
    </div>
    <div class="stat-card" style="animation-delay:150ms">
      <div class="sc-label">Avg Tokens / Session</div>
      <div class="sc-val" id="sv4">â€”</div>
      <div class="sc-sub">per conversation</div>
    </div>
    <div class="stat-card" style="animation-delay:200ms">
      <div class="sc-label">Total LLM Cost</div>
      <div class="sc-val" id="sv5">â€”</div>
      <div class="sc-sub" id="sv5sub">USD from API</div>
    </div>
    <div class="stat-card" style="animation-delay:250ms">
      <div class="sc-label">Avg LLM Cost</div>
      <div class="sc-val" id="sv6">â€”</div>
      <div class="sc-sub">per session</div>
    </div>
  </div>

  <div class="chart-card">
    <div class="card-head">
      <div>
        <div class="card-title">Calls over time</div>
        <div class="card-sub">Number of conversations per day</div>
      </div>
      <div class="legend">
        <div class="leg-item"><div class="leg-dot" style="background:var(--lav)"></div>Sessions</div>
        <div class="leg-item" id="llmLegend" style="display:none"><div class="leg-dot" style="background:var(--peach)"></div>LLM Cost ($)</div>
      </div>
    </div>
    <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
  </div>
</div>

<!-- â•â• CHAT â•â• -->
<div id="chatScreen" class="screen">
  <aside class="sidebar">
    <div class="sidebar-header"><div class="sidebar-title">ğŸ‘¥ Users</div></div>
    <div class="search-box">
      <div class="search-wrap">
        <span class="search-ico">ğŸ”</span>
        <input class="search-input" id="userSearch" type="text" placeholder="Search usersâ€¦" oninput="filterUsers()"/>
      </div>
    </div>
    <div class="users-wrap" id="usersList">
      <div class="ph"><div class="phi">ğŸ‘¥</div>Loadingâ€¦</div>
    </div>
  </aside>

  <div class="chat-middle">
    <div class="timeline">
      <div class="tl-top">
        <div class="tl-lbl">ğŸ“… Sessions</div>
        <div class="tl-cnt" id="tlCnt">â€”</div>
      </div>
      <div class="dfbar" id="dfbar"><span class="df-lbl">Filter:</span></div>
      <div class="tl-scroll" id="tlScroll">
        <div class="center-state">
          <div class="cs-icon">ğŸ—“ï¸</div>
          <div class="cs-title">No sessions yet</div>
          <div class="cs-sub">Select a user from the sidebar.</div>
        </div>
      </div>
    </div>

    <div class="tr-panel" id="trPanel">
      <div class="hint"><div class="hint-icon">ğŸ’¬</div><p>Select a session to read the full transcript âœ¨</p></div>
    </div>
  </div>

  <aside class="info-panel" id="infoPanel">
    <div class="ip-header"><div class="ip-title">â„¹ï¸ Conversation Info</div></div>
    <div class="ip-body" id="ipBody">
      <div class="ip-empty"><div class="ip-empty-icon">ğŸ“‹</div><div class="ip-empty-text">Select a session to see details</div></div>
    </div>
  </aside>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://zkbkqihjtvbohjjsgwkv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprYmtxaWhqdHZib2hqanNnd2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4OTcyMzcsImV4cCI6MjA4NzQ3MzIzN30.PocVPJrZfEiGM7XGvewlWR2GlGFPn3KXkSClyoqC8_A';
const BACKEND_URL = 'https://agentdashboard-production-5777.up.railway.app';
const API_SECRET  = '9a386d5511ebaf9086545ad5ffb20da4664a271ab909e106a67b96fc3d18887e';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

// â”€â”€ URL PARAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const P          = new URLSearchParams(location.search);
const agentDbId  = P.get('agentDbId') || '';
const agentName  = P.get('name')      || 'Agent';
const agentIdVal = P.get('agentId')   || '';
const agentEmoji = P.get('emoji')     || 'ğŸ¤–';
const agentColor = P.get('color')     || 'lav';

document.title = `Agent Analytics â€” ${agentName}`;
document.getElementById('agentName').textContent = agentName;
document.getElementById('agentIdEl').textContent = agentIdVal || 'No agent ID';
const avEl = document.getElementById('agentAv');
avEl.textContent = agentEmoji; avEl.dataset.color = agentColor;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allConvs       = [];
let userMap        = {};
let userLatestConv = {};
let activeUser = null, activeConv = null, activeDayFilter = null;
let chartInst  = null;
let currentUserRole = null;

// â”€â”€ BACKEND HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendFetch(path, options = {}) {
  const { data: { session } } = await sb.auth.getSession();
  const token = session?.access_token;
  const res = await fetch(`${BACKEND_URL}${path}`, {
    ...options,
    headers: {
      'Content-Type':  'application/json',
      'x-api-secret':  API_SECRET,
      ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
      ...(options.headers || {}),
    },
  });
  const data = await res.json();
  if (!res.ok || !data.success) throw new Error(data?.error?.message || `Backend error ${res.status}`);
  return data;
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t) {
  document.getElementById('tabOv').classList.toggle('active', t==='ov');
  document.getElementById('tabCh').classList.toggle('active', t==='ch');
  document.getElementById('overviewScreen').classList.toggle('active', t==='ov');
  document.getElementById('chatScreen').classList.toggle('active', t==='ch');
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const esc      = s => s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
const fmtDur   = s => { if (!s) return 'â€”'; if (s<60) return s+'s'; return `${Math.floor(s/60)}m ${s%60}s`; };
const fmtTime  = u => u ? new Date(u*1000).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}) : 'â€”';
const fmtDate  = u => u ? new Date(u*1000).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}) : 'â€”';
const daySort  = u => u ? new Date(u*1000).toISOString().slice(0,10) : '0000-00-00';
const initials = n => { if (!n||n==='Unknown User') return '?'; const p=n.trim().split(' '); return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():n.slice(0,2).toUpperCase(); };
const stClass  = s => ({done:'st-done',failed:'st-failed',processing:'st-processing'}[s]||'st-in-progress');

function dayLabel(u) {
  if (!u) return 'Unknown Date';
  const d=new Date(u*1000),t=new Date(),y=new Date(); y.setDate(t.getDate()-1);
  if (d.toDateString()===t.toDateString()) return 'ğŸŒŸ Today';
  if (d.toDateString()===y.toDateString()) return 'ğŸŒ™ Yesterday';
  return d.toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'long'});
}
function dayLabelShort(u) {
  if (!u) return '?';
  const d=new Date(u*1000),t=new Date(),y=new Date(); y.setDate(t.getDate()-1);
  if (d.toDateString()===t.toDateString()) return 'Today';
  if (d.toDateString()===y.toDateString()) return 'Yesterday';
  return d.toLocaleDateString('en-IN',{day:'numeric',month:'short'});
}

// â”€â”€ TOKEN EXTRACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Path: row.metadata -> charging -> llm_usage
//   -> irreversible_generation -> model_usage -> input.tokens / output_total.tokens
//   -> initiated_generation    -> model_usage -> input.tokens / output_total.tokens
function rowToTokens(row) {
  if (!row?.metadata) return null;
  try {
    const meta     = typeof row.metadata === 'string' ? JSON.parse(row.metadata) : row.metadata;
    const charging = meta?.charging || {};
    const llmUsage = charging?.llm_usage || {};

    const irrevGen = llmUsage?.irreversible_generation?.model_usage || {};
    const initGen  = llmUsage?.initiated_generation?.model_usage    || {};

    const input  = (irrevGen?.input?.tokens        || 0) + (initGen?.input?.tokens        || 0);
    const output = (irrevGen?.output_total?.tokens  || 0) + (initGen?.output_total?.tokens  || 0);

    if (!input && !output) return null;
    return { input, output, total: input + output };
  } catch {
    return null;
  }
}

// â”€â”€ COST EXTRACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Priority:
//   1. row.llm_cost  (charging.llm_charge â€” most specific, LLM only)
//   2. row.cost      (metadata.cost â€” total conversation cost)
//   3. metadata.charging.llm_charge â€” fallback if DB columns are null (old rows)
//   4. metadata.cost â€” fallback for old rows
function rowToCost(row) {
  // DB columns (set by syncService.buildRow on new syncs)
  if (row.llm_cost != null && Number(row.llm_cost) > 0) return { cost: Number(row.llm_cost), label: 'LLM' };
  if (row.cost     != null && Number(row.cost)     > 0) return { cost: Number(row.cost),     label: 'total' };

  // Fallback: read directly from stored metadata (covers rows synced before fix)
  try {
    const meta     = row.metadata ? (typeof row.metadata === 'string' ? JSON.parse(row.metadata) : row.metadata) : {};
    const charging = meta?.charging || {};
    if (charging?.llm_charge != null && Number(charging.llm_charge) > 0)
      return { cost: Number(charging.llm_charge), label: 'LLM' };
    if (meta?.cost != null && Number(meta.cost) > 0)
      return { cost: Number(meta.cost), label: 'total' };
  } catch {}

  return null;
}

function rowToTranscript(row) {
  if (!row?.transcript) return [];
  return Array.isArray(row.transcript) ? row.transcript : [];
}

function extractUserName(row) {
  if (row.user_name) return row.user_name;
  if (row.metadata) {
    try {
      const meta = typeof row.metadata === 'string' ? JSON.parse(row.metadata) : row.metadata;
      const dv   = meta?.conversation_initiation_client_data?.dynamic_variables;
      if (dv?.user_name) return dv.user_name;
      if (dv) {
        for (const k of Object.keys(dv)) {
          if (k.toLowerCase().includes('name') || k.toLowerCase().includes('user')) {
            const v = dv[k];
            if (v && typeof v === 'string' && v.length < 40) return v;
          }
        }
      }
    } catch {}
  }
  const tr = rowToTranscript(row);
  for (const t of tr.slice(0, 20)) {
    if (t.role === 'agent' && t.message) {
      const m = t.message.match(/\b(?:hey|hello|hi)\s+([A-Z][a-z]{1,30})\b/i);
      if (m) return m[1];
    }
  }
  return null;
}

// â”€â”€ FORMAT HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtCost = c => {
  if (c === null || c === undefined) return null;
  if (c === 0) return '$0.00';
  if (c < 0.000001) return '<$0.000001';
  if (c < 0.001)    return `$${c.toFixed(6)}`;
  if (c < 0.01)     return `$${c.toFixed(5)}`;
  return `$${c.toFixed(4)}`;
};
const fmtTokens = n => {
  if (!n && n !== 0) return 'â€”';
  if (n >= 1_000_000) return (n/1_000_000).toFixed(2)+'M';
  if (n >= 1_000)     return (n/1_000).toFixed(1)+'K';
  return String(n);
};

// â”€â”€ SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function triggerSync() {
  if (!agentDbId) return;
  const btn = document.getElementById('syncBtn');
  btn.disabled = true; btn.classList.add('syncing'); btn.textContent = 'ğŸ”„ Syncingâ€¦';
  try {
    const result = await backendFetch(`/api/conversations/sync/${agentDbId}`, { method: 'POST' });
    const { newCount, lastSyncedAt } = result.data;
    btn.textContent = `âœ“ ${newCount} new`;
    setTimeout(() => { btn.textContent = 'ğŸ”„ Sync Now'; }, 3000);
    updateSyncStatus(lastSyncedAt);
    if (newCount > 0) await loadConversations();
  } catch (err) {
    btn.textContent = 'âŒ Failed';
    setTimeout(() => { btn.textContent = 'ğŸ”„ Sync Now'; }, 3000);
    console.error('[Dashboard] Sync failed:', err.message);
  } finally {
    btn.disabled = false; btn.classList.remove('syncing');
  }
}

// Full re-sync: deletes ALL cached conversations for this agent
// then syncs everything fresh from ElevenLabs.
// This is needed to fix old rows that were stored without cost/token data.
async function triggerFullResync() {
  if (!agentDbId) return;
  if (!confirm('This will delete all cached conversations and re-fetch everything from ElevenLabs.\n\nThis fixes missing cost and token data. Continue?')) return;

  const btn = document.getElementById('resyncBtn');
  btn.disabled = true; btn.textContent = 'â™»ï¸ Wiping cacheâ€¦';

  try {
    // Step 1: Delete all cached conversations for this agent via backend
    await backendFetch(`/api/conversations/reset/${agentDbId}`, { method: 'DELETE' });

    btn.textContent = 'â™»ï¸ Re-syncingâ€¦';

    // Step 2: Full sync (no checkpoint â€” fetches everything)
    const result = await backendFetch(`/api/conversations/sync/${agentDbId}`, { method: 'POST' });
    const { newCount, lastSyncedAt } = result.data;

    btn.textContent = `âœ“ ${newCount} fetched`;
    setTimeout(() => { btn.textContent = 'â™»ï¸ Re-sync All'; }, 4000);
    updateSyncStatus(lastSyncedAt);
    await loadConversations();
  } catch (err) {
    btn.textContent = 'âŒ Failed';
    setTimeout(() => { btn.textContent = 'â™»ï¸ Re-sync All'; }, 3000);
    console.error('[Dashboard] Full re-sync failed:', err.message);
    alert('Re-sync failed: ' + err.message);
  } finally {
    btn.disabled = false;
  }
}

function updateSyncStatus(lastSyncedAt) {
  const dot   = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  if (!lastSyncedAt) {
    dot.className = 'sync-dot never'; label.textContent = 'Never synced'; return;
  }
  const mins = Math.floor((Date.now() - new Date(lastSyncedAt).getTime()) / 60000);
  dot.className = mins > 60 ? 'sync-dot stale' : 'sync-dot';
  label.textContent = mins < 1 ? 'Synced just now'
    : mins < 60 ? `Synced ${mins}m ago`
    : `Synced ${Math.floor(mins/60)}h ago`;
}

// â”€â”€ INIT & LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  if (!agentDbId) {
    document.getElementById('usersList').innerHTML =
      `<div class="ph"><div class="phi">âš ï¸</div>No agent ID.<br/><a href="index.html">â† Go back</a></div>`;
    return;
  }
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    const { data: profile } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
    currentUserRole = profile?.role;
    if (currentUserRole === 'admin') {
      document.getElementById('syncWrap').style.display = 'flex';
    }
  }
  await loadConversations();
}

async function loadConversations() {
  document.getElementById('loadBar').classList.add('on');
  setLoadingState('Fetching conversations from cacheâ€¦');
  try {
    const result = await backendFetch(`/api/conversations/${agentDbId}?limit=1000`);
    allConvs = result.data.conversations || [];
    updateSyncStatus(result.data.lastSyncedAt);
    if (!allConvs.length) {
      const msg = currentUserRole === 'admin'
        ? 'No conversations cached yet. Click "Sync Now" to fetch from ElevenLabs.'
        : 'No conversations available yet.';
      document.getElementById('usersList').innerHTML =
        `<div class="ph"><div class="phi">ğŸŒµ</div>${msg}</div>`;
      renderOverview();
      return;
    }
    buildUserMap();
    renderUsers(sortedUserNames());
    renderOverview();
  } catch (err) {
    const isOffline = err.message.includes('fetch') || err.message.includes('Failed to fetch');
    document.getElementById('usersList').innerHTML = `
      <div class="ph">
        <div class="phi">${isOffline ? 'ğŸ”Œ' : 'ğŸ˜¬'}</div>
        ${isOffline ? 'Backend offline.<br/>Start your backend server and refresh.' : esc(err.message)}
      </div>`;
    console.error('[Dashboard] loadConversations error:', err);
  } finally {
    document.getElementById('loadBar').classList.remove('on');
  }
}

function setLoadingState(msg) {
  document.getElementById('usersList').innerHTML = `
    <div class="ph" style="gap:10px;display:flex;flex-direction:column;align-items:center;">
      <div class="spinner"></div>
      <div style="font-size:.75rem;font-weight:700;color:var(--ink2);text-align:center;">${msg}</div>
    </div>`;
}

// â”€â”€ USER MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildUserMap() {
  userMap = {}; userLatestConv = {};
  for (const row of allConvs) {
    const name = extractUserName(row) || 'Unknown User';
    if (!userMap[name]) userMap[name] = [];
    userMap[name].push(row);
    const t = row.start_time_unix || 0;
    if (!userLatestConv[name] || t > userLatestConv[name]) userLatestConv[name] = t;
  }
}

function sortedUserNames() {
  return Object.keys(userMap).sort((a, b) => {
    const diff = (userLatestConv[b] || 0) - (userLatestConv[a] || 0);
    return diff !== 0 ? diff : a.localeCompare(b);
  });
}

// â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOverview() {
  const n = allConvs.length;

  const durs = allConvs.map(r => r.duration_secs).filter(Boolean);
  const avgD = durs.length ? Math.round(durs.reduce((a,b)=>a+b,0) / durs.length) : 0;

  const tokensList = allConvs.map(rowToTokens).filter(Boolean);
  const totInput   = tokensList.reduce((a,t) => a + t.input,  0);
  const totOutput  = tokensList.reduce((a,t) => a + t.output, 0);
  const totTokens  = totInput + totOutput;
  const avgTokens  = tokensList.length ? Math.round(totTokens / tokensList.length) : 0;
  const hasTokens  = tokensList.length > 0;

  const sessionCosts = allConvs.map(rowToCost).filter(Boolean);
  const totLLM  = sessionCosts.reduce((a, s) => a + s.cost, 0);
  const avgLLM  = sessionCosts.length ? totLLM / sessionCosts.length : null;
  const hasLLM  = sessionCosts.length > 0;

  document.getElementById('sv1').textContent = n || '0';
  document.getElementById('sv2').textContent = fmtDur(avgD);

  if (hasTokens) {
    document.getElementById('sv3').textContent    = fmtTokens(totTokens);
    document.getElementById('sv3sub').textContent = `${fmtTokens(totInput)} in Â· ${fmtTokens(totOutput)} out`;
    document.getElementById('sv4').textContent    = fmtTokens(avgTokens);
  } else {
    document.getElementById('sv3').textContent    = 'â€”';
    document.getElementById('sv3sub').textContent = 'sync again to get token data';
    document.getElementById('sv4').textContent    = 'â€”';
  }

  document.getElementById('sv5').textContent    = hasLLM ? (fmtCost(totLLM) || 'â€”') : 'â€”';
  document.getElementById('sv5sub').textContent = hasLLM ? 'USD from API' : 'sync again to get cost data';
  document.getElementById('sv6').textContent    = avgLLM !== null ? (fmtCost(avgLLM) || 'â€”') : 'â€”';
  document.getElementById('llmLegend').style.display = hasLLM ? 'flex' : 'none';

  renderChart(hasLLM);
}

function renderChart(hasLLM) {
  const buckets = {};
  for (const row of allConvs) {
    const u  = row.start_time_unix;
    const sk = u ? new Date(u*1000).toISOString().slice(0,10) : '0000';
    const lb = u ? new Date(u*1000).toLocaleDateString('en-IN',{day:'numeric',month:'short'}) : '?';
    if (!buckets[sk]) buckets[sk] = { lbl: lb, n: 0, llm: 0 };
    buckets[sk].n++;
    const sess = rowToCost(row);
    if (sess) buckets[sk].llm += sess.cost;
  }
  const keys   = Object.keys(buckets).sort();
  const labels = keys.map(k => buckets[k].lbl);
  const counts = keys.map(k => buckets[k].n);
  const llmVs  = keys.map(k => parseFloat(buckets[k].llm.toFixed(5)));

  if (chartInst) { chartInst.destroy(); chartInst = null; }
  const ctx = document.getElementById('mainChart').getContext('2d');
  chartInst = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label:'Sessions', data:counts,
          borderColor:'#9b7ff4', backgroundColor:'rgba(155,127,244,0.08)',
          borderWidth:2.5, pointBackgroundColor:'#9b7ff4',
          pointRadius:4, pointHoverRadius:6, tension:0.35, fill:true, yAxisID:'y',
        },
        ...(hasLLM ? [{
          label:'LLM Cost ($)', data:llmVs,
          borderColor:'#ff8c6b', backgroundColor:'rgba(255,140,107,0.07)',
          borderWidth:2, pointBackgroundColor:'#ff8c6b',
          pointRadius:4, pointHoverRadius:6, tension:0.35, fill:true,
          borderDash:[5,4], yAxisID:'y2',
        }] : []),
      ],
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'#fff', borderColor:'#ede9e4', borderWidth:1.5,
          titleColor:'#2d2926', bodyColor:'#6b6560', padding:12, cornerRadius:10,
          titleFont:{family:'Nunito',weight:'800',size:12},
          bodyFont:{family:'Nunito',weight:'600',size:11},
          callbacks:{label:ctx=>ctx.dataset.label==='LLM Cost ($)'
            ? `  LLM Cost: $${ctx.parsed.y.toFixed(5)}`
            : `  Sessions: ${ctx.parsed.y}`},
        },
      },
      scales:{
        x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'Nunito',weight:'700',size:10},color:'#aba49c'}},
        y:{position:'left',grid:{color:'rgba(0,0,0,0.05)'},ticks:{font:{family:'Nunito',weight:'700',size:10},color:'#9b7ff4',stepSize:1},beginAtZero:true},
        ...(hasLLM?{y2:{position:'right',grid:{drawOnChartArea:false},ticks:{font:{family:'Nunito',weight:'700',size:10},color:'#ff8c6b',callback:v=>'$'+v.toFixed(4)},beginAtZero:true}}:{}),
      },
    },
  });
}

// â”€â”€ RENDER USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsers(names) {
  const el = document.getElementById('usersList');
  if (!names.length) { el.innerHTML=`<div class="ph"><div class="phi">ğŸ”</div>No users match!</div>`; return; }
  el.innerHTML = `<div class="users-header">ğŸ‘¥ Users (${names.length})</div>`;
  names.forEach((name, i) => {
    const convs     = userMap[name] || [];
    const latestTs  = userLatestConv[name];
    const latestStr = latestTs ? dayLabelShort(latestTs) : 'â€”';
    const div = document.createElement('div');
    div.className = 'user-row slide-up' + (name===activeUser?' active':'');
    div.style.animationDelay = (i * 22) + 'ms';
    div.innerHTML = `
      <div class="u-av">${esc(initials(name))}</div>
      <div class="u-info">
        <div class="u-name">${esc(name)}</div>
        <div class="u-meta">${convs.length} session${convs.length!==1?'s':''} Â· last ${latestStr}</div>
      </div>
      <div class="u-badge">${convs.length}</div>`;
    div.onclick = () => selectUser(name);
    el.appendChild(div);
  });
}

function filterUsers() {
  const q = document.getElementById('userSearch').value.trim().toLowerCase();
  renderUsers(sortedUserNames().filter(n => n.toLowerCase().includes(q)));
}

// â”€â”€ SELECT USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectUser(name) {
  activeUser = name; activeConv = null; activeDayFilter = null;
  document.querySelectorAll('.user-row').forEach(r =>
    r.classList.toggle('active', r.querySelector('.u-name')?.textContent === name));
  const convs = userMap[name] || [];
  buildDateFilter(convs);
  renderTimeline(convs);
  showHint();
  switchTab('ch');
}

// â”€â”€ DATE FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDateFilter(convs) {
  const bar = document.getElementById('dfbar'), dm = {};
  for (const r of convs) { const u=r.start_time_unix; if(!u)continue; const k=daySort(u); if(!dm[k])dm[k]=dayLabelShort(u); }
  const days = Object.keys(dm).sort().reverse();
  if (days.length <= 1) { bar.className='dfbar'; return; }
  bar.innerHTML = '<span class="df-lbl">Filter:</span>';
  const ac = document.createElement('div');
  ac.className='df-chip all active'; ac.textContent=`All (${convs.length})`;
  ac.onclick=()=>applyDayFilter(null,convs); bar.appendChild(ac);
  days.forEach(k => {
    const cnt  = convs.filter(r=>daySort(r.start_time_unix)===k).length;
    const chip = document.createElement('div');
    chip.className='df-chip'; chip.dataset.day=k;
    chip.textContent=`${dm[k]} (${cnt})`;
    chip.onclick=()=>applyDayFilter(k,convs); bar.appendChild(chip);
  });
  bar.className='dfbar vis';
}

function applyDayFilter(dk, all) {
  activeDayFilter=dk; activeConv=null;
  document.querySelectorAll('.df-chip').forEach(c=>c.classList.toggle('active',dk===null?c.classList.contains('all'):c.dataset.day===dk));
  renderTimeline(dk ? all.filter(r=>daySort(r.start_time_unix)===dk) : all);
  showHint();
}

// â”€â”€ TIMELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTimeline(rows) {
  const scr = document.getElementById('tlScroll');
  document.getElementById('tlCnt').textContent = `${rows.length} session${rows.length!==1?'s':''}`;
  if (!rows.length) { scr.innerHTML=`<div class="center-state"><div class="cs-icon">ğŸ“­</div><div class="cs-title">No sessions</div></div>`; return; }

  const groups = {};
  for (const r of rows) {
    const k=daySort(r.start_time_unix), l=dayLabel(r.start_time_unix);
    if (!groups[k]) groups[k]={l,rows:[]};
    groups[k].rows.push(r);
  }
  const days = Object.keys(groups).sort().reverse();
  scr.innerHTML = '';
  days.forEach((day, di) => {
    const { l, rows: dc } = groups[day];
    dc.sort((a,b)=>(b.start_time_unix||0)-(a.start_time_unix||0));
    const grp = document.createElement('div');
    grp.className='day-grp slide-up'; grp.style.animationDelay=(di*40)+'ms';
    grp.innerHTML=`<div class="day-strip"><div class="day-pill">${esc(l)}</div><div class="day-line"></div><div class="day-n">${dc.length}</div></div>`;
    dc.forEach((r, ci) => {
      const u    = r.start_time_unix;
      const tok  = rowToTokens(r);
      const sess = rowToCost(r);
      const ls   = sess ? fmtCost(sess.cost) : null;
      const tr   = rowToTranscript(r);
      const prev = tr.find(t=>t.role==='user')?.message || 'No preview';
      const card = document.createElement('div');
      card.className='sess-card slide-up'+(r.conversation_id===activeConv?' active':'');
      card.style.animationDelay=(di*40+ci*18)+'ms';
      const userTurns = tr.filter(t=>t.role==='user').length;
      card.innerHTML=`
        <div class="sc-top">
          <div class="sc-time">${fmtTime(u)}</div>
          <div class="sc-stat ${stClass(r.status)}">${r.status||'â€”'}</div>
        </div>
        <div class="sc-prev">${esc(prev)}</div>
        <div class="sc-chips">
          ${r.duration_secs?`<span class="sc-chip">â± ${fmtDur(r.duration_secs)}</span>`:''}
          ${userTurns?`<span class="sc-chip">ğŸ’¬ ${userTurns} quer${userTurns!==1?'ies':'y'}</span>`:''}
          ${tok?`<span class="sc-chip">ğŸ”¢ ${fmtTokens(tok.total)}</span>`:''}
          ${ls?`<span class="sc-chip llm">ğŸ’° ${ls}</span>`:''}
        </div>`;
      card.onclick = () => openTranscript(r, activeUser, card);
      grp.appendChild(card);
    });
    scr.appendChild(grp);
  });
}

// â”€â”€ TRANSCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTranscript(row, userName, cardEl) {
  document.querySelectorAll('.sess-card').forEach(c=>c.classList.remove('active'));
  cardEl.classList.add('active');
  activeConv = row.conversation_id;
  renderTranscript(row, userName);
}

function renderTranscript(row, userName) {
  const tr    = rowToTranscript(row);
  const dName = userName || extractUserName(row) || 'User';
  const ini   = initials(dName);
  const tok   = rowToTokens(row);
  const cost  = rowToCost(row);

  const ipRows = [
    { label:'Conversation ID', value: row.conversation_id,  mono:true, small:true },
    { label:'Status',          value: `<span class="sc-stat ${stClass(row.status)}" style="font-size:.65rem">${row.status||'â€”'}</span>`, html:true },
    { label:'Date',            value: row.start_time_unix ? fmtDate(row.start_time_unix) : 'â€”' },
    { label:'Time',            value: row.start_time_unix ? fmtTime(row.start_time_unix) : 'â€”' },
    { label:'Duration',        value: fmtDur(row.duration_secs) },
    { label:'LLM Charge',      value: row.llm_cost != null ? (fmtCost(Number(row.llm_cost)) || 'â€”') : (cost?.label === 'LLM' ? fmtCost(cost.cost) : 'â€”') },
    { label:'Total Cost',      value: row.cost     != null ? (fmtCost(Number(row.cost))     || 'â€”') : (cost?.label === 'total' ? fmtCost(cost.cost) : 'â€”') },
    { label:'Tokens In',       value: tok ? fmtTokens(tok.input)  : 'â€”' },
    { label:'Tokens Out',      value: tok ? fmtTokens(tok.output) : 'â€”' },
    { label:'Total Tokens',    value: tok ? fmtTokens(tok.total)  : 'â€”' },
  ];

  document.getElementById('ipBody').innerHTML = `
    <div class="ip-user">
      <div class="ip-av">${esc(ini)}</div>
      <div class="ip-uname">${esc(dName)}</div>
    </div>
    <div class="ip-divider"></div>
    ${ipRows.map(r=>`
      <div class="ip-row">
        <div class="ip-lbl">${r.label}</div>
        <div class="ip-val${r.mono?' mono':''}${r.small?' ip-val-sm':''}">${r.html?r.value:esc(String(r.value))}</div>
      </div>`).join('')}`;

  const panel = document.getElementById('trPanel');
  panel.className = 'tr-panel pop-in';
  panel.innerHTML = `
    <div class="tr-head">
      <div class="tr-row1">
        <div class="tr-av">${esc(ini)}</div>
        <div class="tr-info">
          <div class="tr-name">Chat with <em>${esc(dName)}</em></div>
          <div class="tr-id">${esc(row.conversation_id)}</div>
        </div>
      </div>
      ${tok ? `
      <div class="tr-chips">
        <div class="tr-chip llm">ğŸ”¢ ${fmtTokens(tok.input)} in Â· ${fmtTokens(tok.output)} out</div>
        ${cost ? `<div class="tr-chip llm">ğŸ’° ${fmtCost(cost.cost)}</div>` : ''}
      </div>` : ''}
    </div>
    <div class="msgs" id="msgsBox"></div>`;

  const box = document.getElementById('msgsBox');
  if (!tr.length) {
    box.innerHTML=`<div class="center-state"><div class="cs-icon">ğŸ“­</div><div class="cs-title">No messages</div></div>`;
    return;
  }
  tr.forEach((t, i) => {
    const isUser = t.role === 'user', ts = t.time_in_call_secs;
    const tStr   = ts != null ? `${String(Math.floor(ts/60)).padStart(2,'0')}:${String(ts%60).padStart(2,'0')}` : null;
    const row2   = document.createElement('div');
    row2.className = `msg-wrap ${isUser?'user':'agent'} slide-up`;
    row2.style.animationDelay = Math.min(i*12,300)+'ms';
    row2.innerHTML = `
      <div class="msg-av ${isUser?'ut':'at'}">${isUser?esc(ini):'ğŸ¤–'}</div>
      <div class="msg-col">
        <div class="msg-who">${isUser?esc(dName):'Agent'}${tStr?` Â· ${tStr}`:''}</div>
        <div class="msg-bub">${esc(t.message||t.text||'')}</div>
      </div>`;
    box.appendChild(row2);
  });
  box.scrollTop = 0;
}

function showHint() {
  document.getElementById('trPanel').innerHTML=`<div class="hint"><div class="hint-icon">ğŸ’¬</div><p>Select a session to read the full transcript âœ¨</p></div>`;
  document.getElementById('ipBody').innerHTML=`<div class="ip-empty"><div class="ip-empty-icon">ğŸ“‹</div><div class="ip-empty-text">Select a session to see details</div></div>`;
}

document.addEventListener('keydown', e => {
  if ((e.metaKey||e.ctrlKey)&&e.key==='k') { e.preventDefault(); document.getElementById('userSearch').focus(); }
});

init();
</script>
</body>
</html>