<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Indoo â€” Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#faf8f5; --white:#ffffff; --border:#ede9e4; --border2:#ddd8d0;
      --ink:#2d2926; --ink2:#6b6560; --ink3:#aba49c; --ink4:#cec8c0;
      --peach:#ff8c6b; --peach-l:#fff0ec; --peach-m:#ffd4c8;
      --mint:#34c98e;  --mint-l:#edfbf4;  --mint-m:#b6f0d6;
      --lav:#9b7ff4;   --lav-l:#f3f0ff;   --lav-m:#d8cffe;
      --sky:#4aaff7;   --sky-l:#eef7ff;   --sky-m:#b8dfff;
      --rose:#f76b8a;  --rose-l:#fff0f3;  --rose-m:#ffc8d0;
      --amber:#f5a623; --amber-l:#fff8ec; --amber-m:#fce0a0;
      --shadow-s:0 2px 8px rgba(0,0,0,.06);
      --shadow-m:0 4px 20px rgba(0,0,0,.09),0 1px 4px rgba(0,0,0,.04);
      --shadow-l:0 8px 32px rgba(0,0,0,.12),0 2px 8px rgba(0,0,0,.06);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;font-family:'Nunito',sans-serif;background:var(--bg);color:var(--ink);visibility:hidden;}
    body.ready{visibility:visible;}

    /* TOPBAR */
    .topbar{
      position:sticky;top:0;z-index:50;height:62px;
      background:var(--white);border-bottom:1.5px solid var(--border);
      display:flex;align-items:center;padding:0 32px;gap:14px;
    }
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;}
    .logo-icon{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--peach),var(--lav));display:flex;align-items:center;justify-content:center;font-size:1.1rem;box-shadow:0 3px 10px rgba(155,127,244,.3);}
    .logo-name{font-size:1rem;font-weight:900;letter-spacing:-.03em;}
    .logo-badge{font-size:.58rem;font-weight:800;background:var(--rose-l);color:var(--rose);border:1.5px solid var(--rose-m);padding:2px 8px;border-radius:50px;margin-left:4px;}
    .topbar-right{display:flex;align-items:center;gap:10px;margin-left:auto;}
    .nav-link{
      padding:7px 16px;border-radius:50px;font-size:.78rem;font-weight:700;
      color:var(--ink2);border:1.5px solid var(--border);background:var(--bg);
      cursor:pointer;text-decoration:none;transition:all .15s;
    }
    .nav-link:hover{border-color:var(--lav-m);color:var(--lav);background:var(--lav-l);}
    .user-chip{display:flex;align-items:center;gap:7px;padding:5px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:50px;}
    .user-av{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--peach-m),var(--lav-m));display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;color:var(--lav);}
    .user-name{font-size:.75rem;font-weight:700;color:var(--ink2);}
    .btn-logout{padding:7px 16px;border-radius:50px;font-size:.78rem;font-weight:700;color:var(--rose);border:1.5px solid var(--rose-m);background:var(--rose-l);cursor:pointer;transition:all .15s;}
    .btn-logout:hover{background:var(--rose);color:#fff;}

    /* BODY */
    .body{padding:36px 32px 80px;max-width:1100px;margin:0 auto;}

    /* PAGE HEADER */
    .page-head{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:32px;}
    .page-title{font-size:1.4rem;font-weight:900;letter-spacing:-.04em;}
    .page-title span{color:var(--lav);}
    .page-sub{font-size:.82rem;color:var(--ink3);font-weight:500;margin-top:4px;}

    /* SECTION */
    .section{background:var(--white);border:1.5px solid var(--border);border-radius:20px;margin-bottom:24px;overflow:hidden;box-shadow:var(--shadow-s);}
    .section-hd{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 24px;border-bottom:1.5px solid var(--border);
    }
    .section-title{font-size:.85rem;font-weight:900;color:var(--ink);}
    .section-sub{font-size:.68rem;color:var(--ink3);font-weight:500;margin-top:2px;}
    .add-btn{
      display:flex;align-items:center;gap:6px;padding:8px 18px;
      background:linear-gradient(135deg,var(--peach),var(--lav));
      border:none;border-radius:50px;color:#fff;
      font-family:'Nunito',sans-serif;font-weight:800;font-size:.78rem;
      cursor:pointer;box-shadow:0 2px 8px rgba(155,127,244,.3);transition:all .15s;
    }
    .add-btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(155,127,244,.4);}

    /* TABLE */
    .tbl{width:100%;border-collapse:collapse;}
    .tbl th{
      padding:11px 20px;text-align:left;
      font-size:.62rem;font-weight:800;color:var(--ink3);
      text-transform:uppercase;letter-spacing:.08em;
      border-bottom:1.5px solid var(--border);background:var(--bg);
    }
    .tbl td{padding:13px 20px;border-bottom:1px solid var(--border);font-size:.82rem;font-weight:600;vertical-align:middle;}
    .tbl tr:last-child td{border-bottom:none;}
    .tbl tbody tr{transition:background .12s;}
    .tbl tbody tr:hover{background:var(--bg);}

    /* PILLS / BADGES */
    .role-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:50px;font-size:.65rem;font-weight:800;border:1.5px solid;}
    .role-admin{background:var(--lav-l);color:var(--lav);border-color:var(--lav-m);}
    .role-client{background:var(--sky-l);color:var(--sky);border-color:var(--sky-m);}
    .status-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:50px;font-size:.65rem;font-weight:800;border:1.5px solid;}
    .status-active{background:var(--mint-l);color:#166534;border-color:var(--mint-m);}
    .status-pending{background:var(--amber-l);color:#92400e;border-color:var(--amber-m);}

    .mono{font-family:'Fira Code',monospace;font-size:.7rem;color:var(--ink2);}

    /* ACTION BUTTONS */
    .act-btn{
      padding:5px 12px;border-radius:50px;font-size:.68rem;font-weight:700;
      cursor:pointer;border:1.5px solid;transition:all .15s;
    }
    .act-btn.edit{color:var(--lav);background:var(--lav-l);border-color:var(--lav-m);}
    .act-btn.edit:hover{background:var(--lav);color:#fff;}
    .act-btn.danger{color:var(--rose);background:var(--rose-l);border-color:var(--rose-m);}
    .act-btn.danger:hover{background:var(--rose);color:#fff;}
    .act-btn.assign{color:var(--mint);background:var(--mint-l);border-color:var(--mint-m);}
    .act-btn.assign:hover{background:var(--mint);color:#fff;}
    .acts{display:flex;gap:6px;align-items:center;}

    /* EMPTY STATE */
    .tbl-empty{padding:48px 24px;text-align:center;color:var(--ink3);font-size:.82rem;}
    .tbl-empty-icon{font-size:1.8rem;margin-bottom:8px;opacity:.3;}

    /* MODAL */
    .overlay{display:none;position:fixed;inset:0;background:rgba(45,41,38,.45);backdrop-filter:blur(6px);z-index:200;align-items:center;justify-content:center;}
    .overlay.open{display:flex;}
    .modal{background:var(--white);border:1.5px solid var(--border);border-radius:24px;padding:32px;width:100%;max-width:460px;box-shadow:var(--shadow-l);animation:modalIn .22s cubic-bezier(.34,1.56,.64,1) both;}
    @keyframes modalIn{from{opacity:0;transform:scale(.93) translateY(10px)}to{opacity:1;transform:none}}
    .modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
    .modal-title{font-size:1.05rem;font-weight:900;letter-spacing:-.02em;}
    .modal-x{width:30px;height:30px;border-radius:50%;border:1.5px solid var(--border);background:var(--bg);cursor:pointer;font-size:.9rem;color:var(--ink3);display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .modal-x:hover{border-color:var(--rose-m);color:var(--rose);background:var(--rose-l);}
    .field{margin-bottom:16px;}
    .field-label{display:block;font-size:.68rem;font-weight:800;color:var(--ink2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;}
    .field-input,.field-select{width:100%;padding:11px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--ink);font-family:'Nunito',sans-serif;font-size:.86rem;font-weight:600;outline:none;transition:border-color .18s,box-shadow .18s;}
    .field-input:focus,.field-select:focus{border-color:var(--lav);box-shadow:0 0 0 3px var(--lav-l);}
    .field-input::placeholder{color:var(--ink4);font-weight:500;}
    .modal-err{padding:9px 12px;background:var(--rose-l);border:1.5px solid var(--rose-m);border-radius:8px;font-size:.78rem;color:var(--rose);font-weight:600;margin-bottom:14px;display:none;}
    .modal-actions{display:flex;gap:10px;margin-top:4px;}
    .btn-cancel{flex:1;padding:11px;background:var(--bg);border:1.5px solid var(--border2);border-radius:10px;font-family:'Nunito',sans-serif;font-weight:700;font-size:.85rem;color:var(--ink2);cursor:pointer;transition:all .15s;}
    .btn-cancel:hover{border-color:var(--rose-m);color:var(--rose);background:var(--rose-l);}
    .btn-submit{flex:2;padding:11px;background:linear-gradient(135deg,var(--peach),var(--lav));border:none;border-radius:10px;font-family:'Nunito',sans-serif;font-weight:800;font-size:.85rem;color:#fff;cursor:pointer;box-shadow:0 3px 10px rgba(155,127,244,.3);transition:all .15s;}
    .btn-submit:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(155,127,244,.4);}
    .btn-submit:disabled{opacity:.45;cursor:not-allowed;transform:none;}

    /* CHECKBOXES for agent assignment */
    .check-list{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow-y:auto;padding:2px 0;}
    .check-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1.5px solid var(--border);background:var(--bg);cursor:pointer;transition:all .15s;}
    .check-item:hover{border-color:var(--lav-m);background:var(--lav-l);}
    .check-item.checked{border-color:var(--lav);background:var(--lav-l);}
    .check-item input[type=checkbox]{accent-color:var(--lav);width:16px;height:16px;cursor:pointer;}
    .check-label{font-size:.82rem;font-weight:700;flex:1;}
    .check-id{font-size:.62rem;font-family:'Fira Code',monospace;color:var(--ink3);}

    .spinner{width:22px;height:22px;border:2.5px solid var(--border);border-top-color:var(--lav);border-radius:50%;animation:spin .6s linear infinite;margin:32px auto;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* TOAST */
    .toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:#fff;padding:11px 22px;border-radius:50px;font-size:.8rem;font-weight:700;box-shadow:var(--shadow-l);transition:transform .3s cubic-bezier(.34,1.56,.64,1);z-index:999;pointer-events:none;}
    .toast.show{transform:translateX(-50%) translateY(0);}
  </style>
</head>
<body>

<nav class="topbar">
  <a class="logo" href="index.html">
    <div class="logo-icon">ğŸ™ï¸</div>
    <div class="logo-name">Agents Analytics</div>
    <span class="logo-badge">Admin</span>
  </a>
  <div class="topbar-right">
    <a class="nav-link" href="index.html">â† My Agents</a>
    <div class="user-chip">
      <div class="user-av" id="userAv">?</div>
      <div class="user-name" id="userName">Loadingâ€¦</div>
    </div>
    <button class="btn-logout" onclick="logout()">Sign Out</button>
  </div>
</nav>

<div class="body">
  <div class="page-head">
    <div>
      <div class="page-title">Admin <span>Panel</span></div>
      <div class="page-sub">Manage users, roles, and agent access</div>
    </div>
  </div>

  <!-- USERS SECTION -->
  <div class="section">
    <div class="section-hd">
      <div>
        <div class="section-title">ğŸ‘¥ Users</div>
        <div class="section-sub">All registered users and their roles</div>
      </div>
      <button class="add-btn" onclick="openInviteModal()">ï¼‹ Invite User</button>
    </div>
    <div id="usersTableWrap">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- AGENTS SECTION -->
  <div class="section">
    <div class="section-hd">
      <div>
        <div class="section-title">ğŸ¤– Agent Access</div>
        <div class="section-sub">Control which clients can see which agents</div>
      </div>
    </div>
    <div id="accessTableWrap">
      <div class="spinner"></div>
    </div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="overlay" id="inviteOverlay">
  <div class="modal">
    <div class="modal-hd">
      <div class="modal-title">âœ‰ï¸ Invite User</div>
      <button class="modal-x" onclick="closeModals()">âœ•</button>
    </div>
    <div class="field">
      <label class="field-label">Email</label>
      <input class="field-input" type="email" id="inv-email" placeholder="user@company.com"/>
    </div>
    <div class="field">
      <label class="field-label">Role</label>
      <select class="field-select" id="inv-role">
        <option value="client">ğŸ‘¤ Client â€” view assigned agents only</option>
        <option value="admin">ğŸ›¡ï¸ Admin â€” full access</option>
      </select>
    </div>
    <div class="modal-err" id="invErr"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn-submit" id="btnInvite" onclick="inviteUser()">Send Invite âœ‰ï¸</button>
    </div>
  </div>
</div>

<!-- ROLE EDIT MODAL -->
<div class="overlay" id="roleOverlay">
  <div class="modal">
    <div class="modal-hd">
      <div class="modal-title">âœï¸ Edit User Role</div>
      <button class="modal-x" onclick="closeModals()">âœ•</button>
    </div>
    <div class="field">
      <label class="field-label">User</label>
      <input class="field-input" id="role-email" readonly style="opacity:.6"/>
    </div>
    <div class="field">
      <label class="field-label">Role</label>
      <select class="field-select" id="role-select">
        <option value="client">ğŸ‘¤ Client â€” view assigned agents only</option>
        <option value="admin">ğŸ›¡ï¸ Admin â€” full access</option>
      </select>
    </div>
    <div class="modal-err" id="roleErr"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn-submit" id="btnRole" onclick="saveRole()">Save Role</button>
    </div>
  </div>
</div>

<!-- ASSIGN AGENTS MODAL -->
<div class="overlay" id="assignOverlay">
  <div class="modal">
    <div class="modal-hd">
      <div class="modal-title">ğŸ¤– Assign Agents</div>
      <button class="modal-x" onclick="closeModals()">âœ•</button>
    </div>
    <div class="field">
      <label class="field-label">User</label>
      <input class="field-input" id="assign-email" readonly style="opacity:.6"/>
    </div>
    <div class="field">
      <label class="field-label">Agents â€” select which ones this user can access</label>
      <div class="check-list" id="checkList"></div>
    </div>
    <div class="modal-err" id="assignErr"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn-submit" id="btnAssign" onclick="saveAssign()">Save Access</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://zkbkqihjtvbohjjsgwkv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprYmtxaWhqdHZib2hqanNnd2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4OTcyMzcsImV4cCI6MjA4NzQ3MzIzN30.PocVPJrZfEiGM7XGvewlWR2GlGFPn3KXkSClyoqC8_A';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const esc = s => s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
const initials = n => { if (!n) return '?'; const p = n.trim().split(' '); return p.length >= 2 ? (p[0][0]+p[p.length-1][0]).toUpperCase() : n.slice(0,2).toUpperCase(); };

let currentUser = null;
let allUsers    = [];
let allAgents   = [];
let editUserId  = null;
let assignUserId = null;

// â”€â”€ AUTH GUARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'login.html'; return; }

  const { data: profile } = await sb.from('profiles').select('role,full_name,email').eq('id', session.user.id).single();
  if (!profile || profile.role !== 'admin') {
    alert('Access denied. Admin only.');
    window.location.href = 'index.html';
    return;
  }
  currentUser = { ...session.user, ...profile };
  document.getElementById('userAv').textContent   = initials(profile.full_name || profile.email);
  document.getElementById('userName').textContent = profile.full_name || profile.email;

  // Reveal page now that auth is confirmed
  document.body.classList.add('ready');

  await loadAll();
}

async function loadAll() {
  await Promise.all([ loadUsers(), loadAgents() ]);
  renderAccessTable();
}

// â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
  const { data, error } = await sb.from('profiles').select('*').order('created_at');
  if (error) { console.error(error); return; }
  allUsers = data || [];
  renderUsersTable();
}

function renderUsersTable() {
  const wrap = document.getElementById('usersTableWrap');
  if (!allUsers.length) {
    wrap.innerHTML = `<div class="tbl-empty"><div class="tbl-empty-icon">ğŸ‘¥</div>No users yet</div>`;
    return;
  }
  wrap.innerHTML = `
    <table class="tbl">
      <thead><tr>
        <th>User</th><th>Email</th><th>Role</th><th>Joined</th><th>Actions</th>
      </tr></thead>
      <tbody>
        ${allUsers.map(u => `
          <tr>
            <td>
              <div style="display:flex;align-items:center;gap:9px;">
                <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--peach-m),var(--lav-m));display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;color:var(--lav);flex-shrink:0;">
                  ${esc(initials(u.full_name || u.email))}
                </div>
                <span style="font-weight:700;">${esc(u.full_name || 'â€”')}</span>
              </div>
            </td>
            <td class="mono">${esc(u.email)}</td>
            <td><span class="role-badge role-${u.role}">${u.role === 'admin' ? 'ğŸ›¡ï¸ Admin' : 'ğŸ‘¤ Client'}</span></td>
            <td style="color:var(--ink3);font-size:.75rem;">${new Date(u.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</td>
            <td>
              <div class="acts">
                <button class="act-btn edit" onclick="openRoleModal('${u.id}','${esc(u.email)}','${u.role}')">Edit Role</button>
                ${u.role === 'client' ? `<button class="act-btn assign" onclick="openAssignModal('${u.id}','${esc(u.email)}')">Assign Agents</button>` : ''}
                ${u.id !== currentUser.id ? `<button class="act-btn danger" onclick="deleteUser('${u.id}')">Remove</button>` : '<span style="font-size:.68rem;color:var(--ink3);">You</span>'}
              </div>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

// â”€â”€ AGENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAgents() {
  const { data, error } = await sb.from('agents').select('*').order('created_at');
  if (error) { console.error(error); return; }
  allAgents = data || [];
}

// â”€â”€ ACCESS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAccessTable() {
  const clients = allUsers.filter(u => u.role === 'client');
  const wrap    = document.getElementById('accessTableWrap');
  if (!clients.length) {
    wrap.innerHTML = `<div class="tbl-empty"><div class="tbl-empty-icon">ğŸ‘¤</div>No client users yet. Invite clients to assign agents.</div>`;
    return;
  }

  // Load all access rows
  const { data: accessRows } = await sb.from('agent_access').select('user_id, agent_id');
  const accessMap = {};
  for (const row of (accessRows || [])) {
    if (!accessMap[row.user_id]) accessMap[row.user_id] = [];
    accessMap[row.user_id].push(row.agent_id);
  }

  wrap.innerHTML = `
    <table class="tbl">
      <thead><tr><th>Client</th><th>Assigned Agents</th><th>Actions</th></tr></thead>
      <tbody>
        ${clients.map(u => {
          const assigned = (accessMap[u.id] || []);
          const agNames  = assigned.map(aid => {
            const ag = allAgents.find(a => a.id === aid);
            return ag ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:50px;background:var(--lav-l);color:var(--lav);border:1.5px solid var(--lav-m);font-size:.62rem;font-weight:700;">${ag.emoji||'ğŸ¤–'} ${esc(ag.name)}</span>` : '';
          }).filter(Boolean).join(' ');
          return `
            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:9px;">
                  <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--sky-m),var(--lav-m));display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:800;color:var(--sky);">
                    ${esc(initials(u.full_name || u.email))}
                  </div>
                  <div>
                    <div style="font-weight:700;font-size:.82rem;">${esc(u.full_name || u.email)}</div>
                    <div class="mono" style="font-size:.62rem;">${esc(u.email)}</div>
                  </div>
                </div>
              </td>
              <td>
                ${agNames || `<span style="color:var(--ink3);font-size:.75rem;">No agents assigned</span>`}
              </td>
              <td>
                <button class="act-btn assign" onclick="openAssignModal('${u.id}','${esc(u.email)}')">Manage Access</button>
              </td>
            </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

// â”€â”€ INVITE USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openInviteModal() {
  document.getElementById('inv-email').value = '';
  document.getElementById('inv-role').value  = 'client';
  document.getElementById('invErr').style.display = 'none';
  document.getElementById('inviteOverlay').classList.add('open');
  setTimeout(() => document.getElementById('inv-email').focus(), 100);
}

async function inviteUser() {
  const email = document.getElementById('inv-email').value.trim();
  const role  = document.getElementById('inv-role').value;
  if (!email) { showModalErr('invErr', 'Please enter an email'); return; }
  const btn = document.getElementById('btnInvite');
  btn.disabled = true; btn.textContent = 'Invitingâ€¦';

  // Use Supabase admin invite (requires service role key in a real backend)
  // For now, we create a profile entry; user signs up normally and gets the role
  const { error } = await sb.from('pending_invites').insert({ email, role, invited_by: currentUser.id });
  if (error) {
    showModalErr('invErr', error.message);
    btn.disabled = false; btn.textContent = 'Send Invite âœ‰ï¸';
    return;
  }
  closeModals(); showToast(`Invite recorded for ${email}`);
  await loadUsers();
}

// â”€â”€ ROLE EDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRoleModal(id, email, role) {
  editUserId = id;
  document.getElementById('role-email').value   = email;
  document.getElementById('role-select').value  = role;
  document.getElementById('roleErr').style.display = 'none';
  document.getElementById('roleOverlay').classList.add('open');
}

async function saveRole() {
  const role = document.getElementById('role-select').value;
  const btn  = document.getElementById('btnRole');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';
  const { error } = await sb.from('profiles').update({ role }).eq('id', editUserId);
  if (error) { showModalErr('roleErr', error.message); btn.disabled = false; btn.textContent = 'Save Role'; return; }
  closeModals(); showToast('Role updated âœ“');
  await loadAll();
}

// â”€â”€ ASSIGN AGENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openAssignModal(userId, email) {
  assignUserId = userId;
  document.getElementById('assign-email').value = email;
  document.getElementById('assignErr').style.display = 'none';

  // Load current assignments for this user
  const { data: current } = await sb.from('agent_access').select('agent_id').eq('user_id', userId);
  const assigned = new Set((current || []).map(r => r.agent_id));

  const list = document.getElementById('checkList');
  if (!allAgents.length) {
    list.innerHTML = '<div style="color:var(--ink3);font-size:.8rem;padding:8px;">No agents added yet. Add agents from the main page first.</div>';
  } else {
    list.innerHTML = allAgents.map(ag => `
      <label class="check-item ${assigned.has(ag.id) ? 'checked' : ''}" id="ci-${ag.id}">
        <input type="checkbox" value="${ag.id}" ${assigned.has(ag.id) ? 'checked' : ''} onchange="toggleCheckStyle('${ag.id}',this.checked)"/>
        <span style="font-size:1.1rem;">${ag.emoji||'ğŸ¤–'}</span>
        <div style="flex:1;">
          <div class="check-label">${esc(ag.name)}</div>
          <div class="check-id">${esc(ag.agent_id||'â€”')}</div>
        </div>
      </label>`).join('');
  }
  document.getElementById('assignOverlay').classList.add('open');
}

function toggleCheckStyle(id, checked) {
  document.getElementById(`ci-${id}`).classList.toggle('checked', checked);
}

async function saveAssign() {
  const checked = [...document.querySelectorAll('#checkList input[type=checkbox]:checked')].map(el => el.value);
  const btn = document.getElementById('btnAssign');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';

  // Delete existing, then insert new
  await sb.from('agent_access').delete().eq('user_id', assignUserId);
  if (checked.length) {
    const rows = checked.map(agent_id => ({ user_id: assignUserId, agent_id }));
    const { error } = await sb.from('agent_access').insert(rows);
    if (error) { showModalErr('assignErr', error.message); btn.disabled = false; btn.textContent = 'Save Access'; return; }
  }
  closeModals(); showToast('Agent access updated âœ“');
  await loadAll();
}

// â”€â”€ DELETE USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteUser(id) {
  if (!confirm('Remove this user? They will lose access to the dashboard.')) return;
  await sb.from('agent_access').delete().eq('user_id', id);
  await sb.from('profiles').delete().eq('id', id);
  showToast('User removed');
  await loadAll();
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModals() {
  document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open'));
  document.querySelectorAll('.btn-submit').forEach(b => { b.disabled = false; });
  document.getElementById('btnInvite').textContent = 'Send Invite âœ‰ï¸';
  document.getElementById('btnRole').textContent   = 'Save Role';
  document.getElementById('btnAssign').textContent = 'Save Access';
}

function showModalErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.style.display = 'block';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

async function logout() {
  await sb.auth.signOut();
  window.location.href = 'login.html';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModals(); });

init();
</script>
</body>
</html>